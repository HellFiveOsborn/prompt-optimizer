<div class="flex h-screen bg-black text-neutral-300 font-sans">
  <!-- Left Sidebar -->
  <aside
    class="flex-shrink-0 bg-[#0A0A0A] flex flex-col transition-all duration-300 ease-in-out overflow-hidden"
    [class]="isSidebarCollapsed() ? 'w-0 p-0 border-r-0' : 'w-72 p-3 border-r border-neutral-800'"
  >
    <div class="overflow-hidden h-full flex flex-col">
      <div class="space-y-3 p-1">
        <button
          (click)="startNewPrompt()"
          class="w-full text-left px-3 py-2 rounded-lg text-sm font-medium text-white bg-neutral-800 hover:bg-neutral-700 transition-colors flex items-center flex-shrink-0"
        >
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 mr-2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
          </svg>
          New prompt
        </button>
  
        <div class="relative flex-shrink-0">
          <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
            <svg class="h-4 w-4 text-neutral-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
            </svg>
          </div>
          <input
            type="text"
            placeholder="Search prompts..."
            class="block w-full rounded-lg border-0 bg-neutral-800 py-2 pl-9 pr-3 text-neutral-300 placeholder:text-neutral-500 focus:ring-1 focus:ring-inset focus:ring-blue-500 sm:text-sm"
            [value]="searchTerm()"
            (input)="onSearchTermInput($event)"
          />
        </div>
      </div>
      <hr class="border-neutral-800 my-3">


      <div class="flex-grow overflow-y-auto pr-1 space-y-4 min-h-0">
        @for(group of groupedHistory(); track group.originalPrompt) {
        <div class="space-y-1">
          <h4
            (click)="startNewOptimizationFrom(group.originalPrompt)"
            class="px-2.5 pt-2 text-xs font-semibold text-neutral-500 uppercase truncate cursor-pointer hover:text-neutral-300"
            [title]="group.originalPrompt"
          >
            {{ group.originalPrompt }}
          </h4>
          @for(item of group.items; track item.timestamp) { @let flatIndex =
          history().indexOf(item);
          <button
            (click)="viewHistoryItem(flatIndex)"
            class="w-full text-left p-2.5 rounded-lg text-sm transition-colors flex justify-between items-center"
            [class]="activeHistoryIndex() === flatIndex ? 'bg-neutral-800 text-white font-medium' : 'text-neutral-400 hover:bg-neutral-900'"
          >
            <span
              class="font-mono"
              >{{ item.timestamp.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' }) }}</span
            >
            <div class="flex items-center space-x-2 text-xs font-mono">
              <span class="text-green-500 font-semibold"
                >+{{ item.additions }}</span
              >
              <span class="text-red-500 font-semibold"
                >-{{ item.deletions }}</span
              >
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-neutral-500">
                <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 8.25h9m-9 3H12m-9.75 1.51c0 1.6 1.123 2.994 2.707 3.227 1.694.233 3.423.372 5.18.372h.008c1.757 0 3.486-.139 5.18-.372c1.584-.233 2.707-1.626 2.707-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.344 48.344 0 0 0 12 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.024Z" />
              </svg>
            </div>
          </button>
          }
        </div>
        }
      </div>
      <div class="mt-auto flex-shrink-0 p-1">
        <button
          (click)="openSettingsModal()"
          class="w-full text-left px-3 py-2 rounded-lg text-sm font-medium text-neutral-400 hover:bg-neutral-900 hover:text-white transition-colors flex items-center"
        >
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87q.11.06.22.127c.325.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.241-.438.613-.43.992a8 8 0 0 1 0 .255c-.008.378.137.75.43.991l1.004.827c.424.35.534.955.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a7 7 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.281c-.09.543-.56.94-1.11.94h-2.594c-.55 0-1.019-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a7 7 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.991a7 7 0 0 1 0-.255c.007-.38-.138-.751-.43-.992l-1.004-.827a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124q.108-.066.22-.128c.332-.183.582-.495.644-.869z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0"/></svg>
          Settings
        </button>
      </div>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="flex-grow flex flex-col relative overflow-hidden">
    <button 
      (click)="toggleSidebar()" 
      class="absolute top-1/2 -translate-y-1/2 -left-3 z-20 bg-neutral-800 hover:bg-neutral-700 border border-neutral-700 rounded-full w-6 h-6 flex items-center justify-center text-neutral-400 hover:text-white" 
      [title]="isSidebarCollapsed() ? 'Show sidebar' : 'Hide sidebar'">
      @if (isSidebarCollapsed()) {
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5" /></svg>
      } @else {
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" /></svg>
      }
    </button>
    <div class="h-full flex flex-col">
      <!-- Header: Only in results view -->
      <header class="flex justify-center items-center py-3 relative h-14 shrink-0 px-4">
        @if (activeHistoryIndex() !== null || isLoading()) {
        <div class="flex items-center gap-2">
          <h1 class="text-lg font-semibold text-white">Prompt Optimizer</h1>
        </div>
        <div class="absolute right-4 flex items-center space-x-2">
          <button
            (click)="copyToClipboard()"
            class="px-4 py-2 bg-[#2A2A2A] hover:bg-[#3a3a3a] rounded-full text-sm font-medium transition-colors flex items-center"
          >
            @if (!copied()) {
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 mr-2">
               <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2M9 5a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2M9 5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2" />
            </svg>
            <span>Copy</span>
            } @else {
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 mr-2 text-green-400">
              <path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 0 1 .143 1.052l-8 10.5a.75.75 0 0 1-1.127.075l-4.5-4.5a.75.75 0 0 1 1.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 0 1 1.052-.143Z" clip-rule="evenodd" />
            </svg>
            <span class="text-green-400">Copied!</span>
            }
          </button>
          
          <button
            (click)="startNewPrompt()"
            class="px-2.5 py-2.5 bg-[#2A2A2A] hover:bg-[#3a3a3a] rounded-full transition-colors"
          >
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        }
      </header>

      <!-- Main Content Area -->
      <div
        class="flex-grow flex flex-col space-y-6 overflow-y-auto min-h-0 py-6 px-4"
      >
        @if (activeHistoryIndex() === null && !isLoading()) {
        <!-- Initial Prompt Area -->
        <div
          class="w-full max-w-4xl mx-auto bg-[#1C1C1C] rounded-xl shadow-2xl p-1 flex flex-col space-y-2"
        >
          <textarea
            id="user-prompt"
            [value]="userPrompt()"
            (input)="onPromptInput($event)"
            placeholder="You are a helpful assistant..."
            class="w-full h-64 bg-transparent text-neutral-300 rounded-lg p-4 focus:ring-0 focus:border-transparent border-transparent transition duration-200 resize-none placeholder:text-neutral-600 text-lg"
          ></textarea>
          <div class="p-2 flex items-center space-x-6">
            <div>
              <label
                for="model-select"
                class="text-sm font-medium text-neutral-400 mr-3"
                >Target Model:</label
              >
              <select
                id="model-select"
                [value]="targetModel()"
                (change)="onModelChange($event)"
                class="bg-neutral-800 border border-neutral-700 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 p-2"
              >
                @for(model of availableModels(); track model.value) {
                <option [value]="model.value">{{ model.name }}</option>
                }
              </select>
            </div>
            <div>
              <label
                for="objective-select"
                class="text-sm font-medium text-neutral-400 mr-3"
                >Prompt Objective:</label
              >
              <select
                id="objective-select"
                [value]="promptObjective()"
                (change)="onObjectiveChange($event)"
                class="bg-neutral-800 border border-neutral-700 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 p-2"
              >
                @for(objective of availableObjectives(); track objective.value)
                {
                <option [value]="objective.value">{{ objective.name }}</option>
                }
              </select>
            </div>
          </div>
        </div>
        } @else if (isLoading()) {
        <div
          class="flex flex-grow items-center justify-center p-8 text-lg font-medium"
        >
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 gradient-shimmer-icon">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09Zm8.446-7.189L18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.456 2.456Zm-1.365 11.852L16.5 21.75l-.394-1.183a2.25 2.25 0 0 0-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 0 0 1.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 0 0 1.423 1.423l1.183.394-1.183.394a2.25 2.25 0 0 0-1.423 1.423Z" />
          </svg>
          <span class="shimmer-text">{{ loadingMessage() }}</span>
        </div>
        } @else if (error()) {
        <div class="bg-red-900/20 text-red-300 p-4 rounded-lg text-center max-w-4xl mx-auto">
          <p class="font-bold">Error</p>
          <p>{{ error() }}</p>
        </div>
        } @else if (activeHistoryItem(); as item) {
        <!-- Results Area -->
        <h2 class="text-center text-xl font-semibold text-white">
          Optimize for
          {{ getModelName(item.targetModel) }}
          ({{ getObjectiveName(item.promptObjective) }})
        </h2>

        <div class="bg-[#1C1C1C] rounded-lg p-6 max-w-6xl mx-auto w-full">
          @if (showChanges()) {
            <h3 class="text-sm font-semibold text-neutral-400 mb-2 uppercase tracking-wider">
              Resulting Prompt
            </h3>
            <div class="p-4 bg-black/30 rounded-md min-h-full overflow-x-auto">
              <div
                class="text-base leading-relaxed font-sans whitespace-pre-wrap break-words"
                [innerHTML]="item.fullPromptDiffHtml"
              ></div>
            </div>
          } @else {
          <h3
            class="text-sm font-semibold text-neutral-400 mb-2 uppercase tracking-wider"
          >
            Optimized Prompt
          </h3>
          <div
            class="text-base leading-relaxed p-4 bg-black/30 rounded-md overflow-x-auto"
          >
            <pre
              class="whitespace-pre-wrap font-sans"
              >{{ item.optimizedPrompt }}</pre
            >
          </div>
          }
        </div>
        }
      </div>

      <!-- Footer: Always visible -->
      <footer class="mt-auto pb-4 shrink-0 px-4">
        <div class="w-full max-w-4xl mx-auto">
            <div class="flex justify-center mb-2">
            @if(activeHistoryItem(); as item) {
            <button
                (click)="toggleChanges()"
                class="text-sm text-neutral-400 hover:text-white transition-colors flex items-center space-x-1.5 px-3 py-1.5 bg-[#2A2A2A] hover:bg-[#3a3a3a] rounded-full font-medium"
            >
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 8.25h9m-9 3H12m-9.75 1.51c0 1.6 1.123 2.994 2.707 3.227 1.694.233 3.423.372 5.18.372h.008c1.757 0 3.486-.139 5.18-.372c1.584-.233 2.707-1.626 2.707-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.344 48.344 0 0 0 12 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.024Z" />
                </svg>
                <span>Review changes</span>
                <span class="font-mono text-green-400 ml-1.5"
                >+{{ item.additions }}</span
                >
                <span class="font-mono text-red-400 ml-1"
                >-{{ item.deletions }}</span
                >
            </button>
            }
            </div>
            <div class="flex items-center space-x-3 bg-[#1C1C1C] rounded-full p-2">
            @if (isThinking()) {
            <div class="flex items-center space-x-2 text-sm text-neutral-400 shrink-0 ml-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-yellow-400">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 18v-5.25m0 0a6 6 0 0 0 1.5-.189m-1.5.189a6 6 0 0 1-1.5-.189m3.75 7.478a12.1 12.1 0 0 1-4.5 0m3.75 2.383a14.4 14.4 0 0 1-3 0M14.25 18v-.192c0-.983.658-1.823 1.508-2.316a7.5 7.5 0 1 0-7.517 0c.85.493 1.509 1.333 1.509 2.316V18" />
                </svg>
                <span class="font-mono">Thinking {{ thinkingTime() }}s</span>
            </div>
            }
            <input
                type="text"
                [value]="changeRequest()"
                (input)="onChangesInput($event)"
                placeholder="Request changes (optional)..."
                class="w-full bg-transparent text-neutral-300 rounded-full px-4 py-2 focus:ring-0 border-transparent placeholder:text-neutral-500"
                [class.pl-0]="isThinking()"
            />
            <button
                (click)="optimizePrompt()"
                [disabled]="isLoading() || !userPrompt().trim()"
                class="bg-neutral-200 hover:bg-white text-black font-bold py-2 px-6 rounded-full transition duration-200 disabled:bg-neutral-600 disabled:cursor-not-allowed disabled:text-neutral-400 flex items-center justify-center w-28 h-10"
            >
                @if (isLoading()) {
                <svg class="animate-spin h-5 w-5 text-black" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                } @else {
                <span>Optimize</span>
                }
            </button>
            </div>
            <p class="text-center text-xs text-neutral-600 mt-3">
            Prompt Optimizer will apply best practices to your prompts.
            </p>
        </div>
      </footer>
    </div>
  </main>

  <!-- Right Sidebar for Changes -->
  @if (showChanges() && activeHistoryItem(); as item) {
    <aside class="w-96 flex-shrink-0 bg-[#0A0A0A] border-l border-neutral-800 flex flex-col">
        <div class="p-4 overflow-y-auto h-full">
            <h3
            class="text-sm font-semibold text-neutral-400 mb-2 uppercase tracking-wider"
            >
            Analysis & Reasoning
            </h3>
            @if (item.changes.length > 0) {
            <div class="bg-black/30 rounded-md p-4 h-full">
            <ul class="list-none text-sm text-neutral-300 space-y-4">
                @for (change of item.changes; track $index) {
                <li class="flex items-start">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-cyan-400 mr-3 mt-px shrink-0">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09Zm8.446-7.189L18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.456 2.456Zm-1.365 11.852L16.5 21.75l-.394-1.183a2.25 2.25 0 0 0-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 0 0 1.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 0 0 1.423 1.423l1.183.394-1.183.394a2.25 2.25 0 0 0-1.423 1.423Z" />
                    </svg>
                    <span
                    class="break-words min-w-0"
                    >{{ change.reasoning }}</span
                    >
                </li>
                }
            </ul>
            </div>
            }
        </div>
    </aside>
  }

  <!-- Settings Modal -->
  @if (showSettingsModal()) {
  <div
    class="fixed inset-0 bg-black/60 z-40 flex items-center justify-center"
    (click)="closeSettingsModal()"
  >
    <div
      class="bg-[#1C1C1C] rounded-xl shadow-2xl w-full max-w-lg p-6 border border-neutral-700"
      (click)="$event.stopPropagation()"
    >
      <h2 class="text-xl font-bold text-white mb-4">Settings</h2>

      <div class="flex border-b border-neutral-700 mb-6">
          <button (click)="activeSettingsTab.set('gemini')" [class]="activeSettingsTab() === 'gemini' ? 'border-blue-500 text-white' : 'border-transparent text-neutral-400 hover:text-white'" class="px-4 py-2 text-sm font-medium border-b-2 transition-colors">
              Gemini
          </button>
          <button (click)="activeSettingsTab.set('openai')" [class]="activeSettingsTab() === 'openai' ? 'border-blue-500 text-white' : 'border-transparent text-neutral-400 hover:text-white'" class="px-4 py-2 text-sm font-medium border-b-2 transition-colors">
              OpenAI Compatible
          </button>
      </div>
      
      @if (activeSettingsTab() === 'gemini') {
      <div class="space-y-4">
        <p class="text-sm text-neutral-400">
            Use Google's Gemini for prompt optimization. You can provide your own API key if one isn't configured for the environment.
        </p>
        <div>
            <label for="gemini-api-key" class="block text-sm font-medium text-neutral-300 mb-1">API Key</label>
            <input type="password" id="gemini-api-key"
                [value]="tempSettings().gemini.apiKey"
                (input)="onTempGeminiApiKeyInput($event)"
                [disabled]="isGeminiKeyFromEnv()"
                [placeholder]="isGeminiKeyFromEnv() ? 'Using environment API key' : 'Enter your Gemini API key'"
                class="w-full bg-neutral-800 border border-neutral-700 text-white rounded-lg px-3 py-2 focus:ring-blue-500 focus:border-blue-500 disabled:opacity-50"
            />
        </div>
        <div>
            <label for="gemini-model-select" class="block text-sm font-medium text-neutral-300 mb-1">Model</label>
              <select id="gemini-model-select"
                [value]="tempSettings().gemini.model"
                (change)="onTempGeminiModelChange($event)"
                class="w-full bg-neutral-800 border border-neutral-700 text-white rounded-lg px-3 py-2 focus:ring-blue-500 focus:border-blue-500"
            >
                @for(model of availableGeminiModels; track model) {
                <option [value]="model">{{ model }}</option>
                }
            </select>
        </div>
      </div>
      }

      @if (activeSettingsTab() === 'openai') {
      <div class="space-y-4">
        <p class="text-sm text-neutral-400 mb-2">
          Configure a custom OpenAI-compatible endpoint. When configured and saved, this
          will be used instead of Gemini.
        </p>

        <div>
          <label
            for="endpoint-url"
            class="block text-sm font-medium text-neutral-300 mb-1"
            >Endpoint URL</label
          >
          <input
            type="text"
            id="endpoint-url"
            [value]="tempSettings().openai.endpoint"
            (input)="onTempEndpointInput($event)"
            placeholder="https://api.openai.com/v1"
            class="w-full bg-neutral-800 border border-neutral-700 text-white rounded-lg px-3 py-2 focus:ring-blue-500 focus:border-blue-500"
          />
           <p class="mt-2 text-xs text-neutral-500 flex items-start">
            <i class="fa-solid fa-circle-info mr-2 mt-px shrink-0"></i>
            <span>The server at this endpoint must be configured to accept cross-origin requests (CORS).</span>
          </p>
        </div>
        <div>
          <label
            for="api-key"
            class="block text-sm font-medium text-neutral-300 mb-1"
            >API Key</label
          >
          <div class="flex items-center space-x-2">
            <input
              type="password"
              id="api-key"
              [value]="tempSettings().openai.apiKey"
              (input)="onTempApiKeyInput($event)"
              placeholder="sk-..."
              class="flex-grow bg-neutral-800 border border-neutral-700 text-white rounded-lg px-3 py-2 focus:ring-blue-500 focus:border-blue-500"
            />
            <button
              (click)="fetchModels()"
              [disabled]="isFetchingModels()"
              class="p-2 bg-neutral-700 hover:bg-neutral-600 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-wait shrink-0"
              title="Fetch available models"
            >
              @if (isFetchingModels()) {
              <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              } @else {
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-white">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9.004 9.004 0 0 0 8.716-6.747M12 21a9.004 9.004 0 0 1-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3m0 0a9.004 9.004 0 0 1 7.843 4.582M12 3a9.004 9.004 0 0 0-7.843 4.582m15.686 0A11.953 11.953 0 0 1 12 10.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.953 8.953 0 0 1 21 12c0 .778-.099 1.533-.284 2.253m0 0A17.916 17.916 0 0 1 12 16.5a17.916 17.916 0 0 1-8.716-2.247m0 0A9.004 9.004 0 0 1 3 12c0-1.605.42-3.113 1.157-4.418" />
              </svg>
              }
            </button>
          </div>
        </div>
        @if (tempSettings().openai.models.length > 0) {
        <div>
          <label
            for="model-select-modal"
            class="block text-sm font-medium text-neutral-300 mb-1"
            >Execution Model</label
          >
          <select
            id="model-select-modal"
            (change)="onTempModelChange($event)"
            class="w-full bg-neutral-800 border border-neutral-700 text-white rounded-lg px-3 py-2 focus:ring-blue-500 focus:border-blue-500"
          >
            @for(model of tempSettings().openai.models; track model) {
            <option [value]="model" [selected]="model === tempSettings().openai.executionModel">{{ model }}</option>
            }
          </select>
        </div>
        }
        <div class="h-8 mt-2 text-sm">
          @if (fetchModelsError()) {
          <p class="text-red-400">{{ fetchModelsError() }}</p>
          } @else if (isFetchingModels()) {
          <p class="text-neutral-400">Fetching models...</p>
          } @else if (tempSettings().openai.models.length > 0) {
          <p class="text-green-400">
            Successfully fetched {{ tempSettings().openai.models.length }} models.
          </p>
          }
        </div>
      </div>
      }

      <div class="flex justify-end space-x-3 mt-6">
        <button
          (click)="closeSettingsModal()"
          class="px-4 py-2 bg-[#2A2A2A] hover:bg-[#3a3a3a] rounded-full text-sm font-medium transition-colors"
        >
          Cancel
        </button>
        <button
          (click)="saveSettings()"
          class="px-4 py-2 bg-neutral-200 hover:bg-white text-black rounded-full text-sm font-bold transition-colors"
        >
          Save
        </button>
      </div>
    </div>
  </div>
  }
</div>